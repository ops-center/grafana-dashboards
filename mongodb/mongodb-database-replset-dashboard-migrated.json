{
  "kind": "Dashboard",
  "metadata": {
    "name": "1a257fed-f6d2-4635-816a-f4f6f92a6ff0",
    "createdAt": "0001-01-01T00:00:00Z",
    "updatedAt": "0001-01-01T00:00:00Z",
    "version": 0,
    "project": "pp"
  },
  "spec": {
    "display": {
      "name": "KubeDB / MongoDB / Database / ReplicaSet"
    },
    "variables": [
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Interval",
            "hidden": false
          },
          "defaultValue": "$__auto_interval_interval",
          "allowAllValue": false,
          "allowMultiple": false,
          "plugin": {
            "kind": "StaticListVariable",
            "spec": {
              "values": [
                {
                  "label": "auto",
                  "value": "$__auto_interval_interval"
                },
                "1s",
                "5s",
                "1m",
                "5m",
                "1h",
                "6h",
                "1d"
              ]
            }
          },
          "name": "interval"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Datasource",
            "hidden": false
          },
          "defaultValue": "Prometheus",
          "allowAllValue": false,
          "allowMultiple": false,
          "plugin": {
            "kind": "DatasourceVariable",
            "spec": {
              "datasourcePluginKind": "PrometheusDatasource"
            }
          },
          "name": "datasource"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Namespace",
            "hidden": false
          },
          "defaultValue": "demo",
          "allowAllValue": false,
          "allowMultiple": false,
          "sort": "none",
          "plugin": {
            "kind": "PrometheusLabelValuesVariable",
            "spec": {
              "labelName": "namespace",
              "matchers": [
                "kube_namespace_created"
              ]
            }
          },
          "name": "namespace"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Replica Set",
            "hidden": false
          },
          "defaultValue": "shard1",
          "allowAllValue": false,
          "allowMultiple": false,
          "sort": "alphabetical-asc",
          "plugin": {
            "kind": "PrometheusLabelValuesVariable",
            "spec": {
              "labelName": "rs_nm",
              "matchers": [
                "mongodb_members_state{namespace=~\"$namespace\"}"
              ]
            }
          },
          "name": "app"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Pod",
            "hidden": false
          },
          "defaultValue": "mg-sh-shard1-0",
          "allowAllValue": false,
          "allowMultiple": false,
          "sort": "alphabetical-asc",
          "plugin": {
            "kind": "PrometheusLabelValuesVariable",
            "spec": {
              "labelName": "pod",
              "matchers": [
                "mongodb_members_state{rs_nm=\"$app\"}"
              ]
            }
          },
          "name": "pod"
        }
      }
    ],
    "panels": {
      "0_0": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "ReplSet State",
            "description": "Shows the role of the selected member instance (PRIMARY or SECONDARY)"
          },
          "plugin": {
            "kind": "StatChart",
            "spec": {
              "calculation": "last-number",
              "format": {
                "decimalPlaces": 0,
                "unit": "decimal"
              },
              "mappings": [
                {
                  "kind": "Value",
                  "spec": {
                    "result": {
                      "value": "STARTUP"
                    },
                    "value": "0"
                  }
                },
                {
                  "kind": "Value",
                  "spec": {
                    "result": {
                      "value": "PRIMARY"
                    },
                    "value": "1"
                  }
                },
                {
                  "kind": "Value",
                  "spec": {
                    "result": {
                      "value": "REMOVED"
                    },
                    "value": "10"
                  }
                },
                {
                  "kind": "Value",
                  "spec": {
                    "result": {
                      "value": "SECONDARY"
                    },
                    "value": "2"
                  }
                },
                {
                  "kind": "Value",
                  "spec": {
                    "result": {
                      "value": "RECOVERING"
                    },
                    "value": "3"
                  }
                },
                {
                  "kind": "Value",
                  "spec": {
                    "result": {
                      "value": "STARTUP2"
                    },
                    "value": "5"
                  }
                },
                {
                  "kind": "Value",
                  "spec": {
                    "result": {
                      "value": "UNKNOWN"
                    },
                    "value": "6"
                  }
                },
                {
                  "kind": "Value",
                  "spec": {
                    "result": {
                      "value": "ARBITER"
                    },
                    "value": "7"
                  }
                },
                {
                  "kind": "Value",
                  "spec": {
                    "result": {
                      "value": "DOWN"
                    },
                    "value": "8"
                  }
                },
                {
                  "kind": "Value",
                  "spec": {
                    "result": {
                      "value": "ROLLBACK"
                    },
                    "value": "9"
                  }
                }
              ],
              "thresholds": {
                "steps": [
                  {
                    "color": "#73bf69",
                    "value": 0
                  },
                  {
                    "color": "#f2495c",
                    "value": 80
                  }
                ]
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "5m",
                    "query": "mongodb_members_state{pod=~\"$pod\",member_idx=~\"$pod.*\"}",
                    "seriesNameFormat": ""
                  }
                }
              }
            }
          ]
        }
      },
      "0_1": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "ReplSet Members",
            "description": "Shows the number of members in the replica set"
          },
          "plugin": {
            "kind": "StatChart",
            "spec": {
              "calculation": "last-number",
              "format": {
                "decimalPlaces": 0,
                "unit": "decimal"
              },
              "thresholds": {
                "steps": [
                  {
                    "color": "#73bf69",
                    "value": 0
                  },
                  {
                    "color": "#f2495c",
                    "value": 80
                  }
                ]
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "5m",
                    "query": "count by (rs_nm) (mongodb_members_state{rs_nm=~\"$app\", pod=\"$pod\"})",
                    "seriesNameFormat": ""
                  }
                }
              }
            }
          ]
        }
      },
      "0_2": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "ReplSet Last Election",
            "description": "Shows how long ago the last election occurred"
          },
          "plugin": {
            "kind": "StatChart",
            "spec": {
              "calculation": "last-number",
              "format": {
                "decimalPlaces": 1,
                "unit": "seconds"
              },
              "thresholds": {
                "steps": [
                  {
                    "color": "#73bf69",
                    "value": 0
                  },
                  {
                    "color": "#f2495c",
                    "value": 80
                  }
                ]
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "5m",
                    "query": "time() - mongodb_electionCandidateMetrics_lastElectionDate{pod=~\"$pod\"}/1000",
                    "seriesNameFormat": ""
                  }
                }
              }
            }
          ]
        }
      },
      "0_3": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "ReplSet Lag",
            "description": "Shows the current replication lag for the selected member"
          },
          "plugin": {
            "kind": "StatChart",
            "spec": {
              "calculation": "last-number",
              "format": {
                "decimalPlaces": 1,
                "unit": "seconds"
              },
              "thresholds": {
                "steps": [
                  {
                    "color": "#73bf69",
                    "value": 0
                  },
                  {
                    "color": "#f2495c",
                    "value": 80
                  }
                ]
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "5m",
                    "query": "(max(mongodb_mongod_replset_member_optime_date{state=\"PRIMARY\", set=\"$app\"}) - min(mongodb_mongod_replset_member_optime_date{state=\"SECONDARY\"} * on (name) group_left mongodb_mongod_replset_my_name{pod=~\"$pod\"})) or (max(mongodb_members_optimeDate{member_state=\"PRIMARY\", rs_nm=\"$app\", pod=\"$pod\"}) - min(mongodb_members_optimeDate{pod=\"$pod\", member_idx=~\"$pod.*\"})) or vector(0)",
                    "seriesNameFormat": ""
                  }
                }
              }
            }
          ]
        }
      },
      "0_4": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Storage Engine",
            "description": "Shows the storage engine used on the instance (inMemory or wiredTiger)"
          },
          "plugin": {
            "kind": "StatChart",
            "spec": {
              "calculation": "last-number",
              "format": {
                "decimalPlaces": 0,
                "unit": "decimal"
              },
              "mappings": [
                {
                  "kind": "Value",
                  "spec": {
                    "result": {
                      "value": "inMemory"
                    },
                    "value": "0"
                  }
                },
                {
                  "kind": "Value",
                  "spec": {
                    "result": {
                      "value": "wiredTiger"
                    },
                    "value": "1"
                  }
                }
              ],
              "thresholds": {
                "steps": [
                  {
                    "color": "#73bf69",
                    "value": 0
                  },
                  {
                    "color": "#f2495c",
                    "value": 80
                  }
                ]
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "5m",
                    "query": "mongodb_ss_storageEngine_persistent{pod=~\"$pod\"}",
                    "seriesNameFormat": ""
                  }
                }
              }
            }
          ]
        }
      },
      "1_0": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Replication Operations"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {}
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "$interval",
                    "query": "rate(mongodb_ss_opcountersRepl{pod=~\"$pod\", legacy_op_type!~\"(command|getmore|query)\"}[$interval]) or irate(mongodb_ss_opcountersRepl{pod=~\"$pod\", legacy_op_type!~\"(command|getmore|query)\"}[5m])",
                    "seriesNameFormat": "{{legacy_op_type}}"
                  }
                }
              }
            }
          ]
        }
      },
      "1_1": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Replication Lag",
            "description": "Shows the delay between an operation occurring on the primary and that same operation getting applied on the selected member"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {}
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "$interval",
                    "query": "(max(mongodb_mongod_replset_member_optime_date{state=\"PRIMARY\", set=\"$app\"}) - min(mongodb_mongod_replset_member_optime_date{state=\"SECONDARY\"} * on (name) group_left mongodb_mongod_replset_my_name{pod=~\"$pod\"})) or (max(mongodb_members_optimeDate{member_state=\"PRIMARY\", rs_nm=\"$app\", pod=\"$pod\"}) - min(mongodb_members_optimeDate{pod=\"$pod\", member_idx=~\"$pod.*\"})) or vector(0)",
                    "seriesNameFormat": "Lag"
                  }
                }
              }
            }
          ]
        }
      },
      "2_0": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Oplog Getmore Time"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {}
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "$interval",
                    "query": "rate(mongodb_mongod_metrics_repl_network_getmores_total_milliseconds{pod=~\"$pod\"}[$interval]) or irate(mongodb_mongod_metrics_repl_network_getmores_total_milliseconds{pod=~\"$pod\"}[5m]) or rate(mongodb_ss_metrics_repl_network_getmores_totalMillis{pod=~\"$pod\"}[$interval]) or irate(mongodb_ss_metrics_repl_network_getmores_totalMillis{pod=~\"$pod\"}[5m])",
                    "seriesNameFormat": "{{pod}}"
                  }
                }
              }
            }
          ]
        }
      },
      "2_1": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Oplog Buffer Capacity"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {}
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "$interval",
                    "query": "mongodb_ss_metrics_repl_buffer_sizeBytes{pod=~\"$pod\"}",
                    "seriesNameFormat": "Used"
                  }
                }
              }
            },
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "$interval",
                    "query": "mongodb_ss_metrics_repl_buffer_maxSizeBytes{pod=~\"$pod\"}",
                    "seriesNameFormat": "Max"
                  }
                }
              }
            }
          ]
        }
      },
      "2_2": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Oplog Operations"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {}
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "query": "rate(mongodb_ss_metrics_repl_apply_ops{pod=~\"$pod\"}[$interval]) or irate(mongodb_ss_metrics_repl_apply_ops{pod=~\"$pod\"}[5m])",
                    "seriesNameFormat": "Batch Apply"
                  }
                }
              }
            }
          ]
        }
      },
      "2_3": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Oplog Buffered Operations"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {}
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "$interval",
                    "query": "mongodb_mongod_metrics_repl_buffer_count{pod=~\"$pod\"} or mongodb_ss_metrics_repl_buffer_count{pod=~\"$pod\"}",
                    "seriesNameFormat": "Current"
                  }
                }
              }
            }
          ]
        }
      }
    },
    "layouts": [
      {
        "kind": "Grid",
        "spec": {
          "display": {
            "title": "Overview",
            "collapse": {
              "open": true
            }
          },
          "items": [
            {
              "x": 0,
              "y": 1,
              "width": 6,
              "height": 3,
              "content": {
                "$ref": "#/spec/panels/0_0"
              }
            },
            {
              "x": 6,
              "y": 1,
              "width": 4,
              "height": 3,
              "content": {
                "$ref": "#/spec/panels/0_1"
              }
            },
            {
              "x": 10,
              "y": 1,
              "width": 4,
              "height": 3,
              "content": {
                "$ref": "#/spec/panels/0_2"
              }
            },
            {
              "x": 14,
              "y": 1,
              "width": 4,
              "height": 3,
              "content": {
                "$ref": "#/spec/panels/0_3"
              }
            },
            {
              "x": 18,
              "y": 1,
              "width": 6,
              "height": 3,
              "content": {
                "$ref": "#/spec/panels/0_4"
              }
            }
          ]
        }
      },
      {
        "kind": "Grid",
        "spec": {
          "display": {
            "title": "Replication Info",
            "collapse": {
              "open": true
            }
          },
          "items": [
            {
              "x": 0,
              "y": 5,
              "width": 12,
              "height": 7,
              "content": {
                "$ref": "#/spec/panels/1_0"
              }
            },
            {
              "x": 12,
              "y": 5,
              "width": 12,
              "height": 7,
              "content": {
                "$ref": "#/spec/panels/1_1"
              }
            }
          ]
        }
      },
      {
        "kind": "Grid",
        "spec": {
          "display": {
            "title": "Oplog Info",
            "collapse": {
              "open": true
            }
          },
          "items": [
            {
              "x": 0,
              "y": 13,
              "width": 12,
              "height": 7,
              "content": {
                "$ref": "#/spec/panels/2_0"
              }
            },
            {
              "x": 12,
              "y": 13,
              "width": 12,
              "height": 7,
              "content": {
                "$ref": "#/spec/panels/2_1"
              }
            },
            {
              "x": 0,
              "y": 20,
              "width": 12,
              "height": 7,
              "content": {
                "$ref": "#/spec/panels/2_2"
              }
            },
            {
              "x": 12,
              "y": 20,
              "width": 12,
              "height": 7,
              "content": {
                "$ref": "#/spec/panels/2_3"
              }
            }
          ]
        }
      }
    ],
    "duration": "1h"
  }
}